{
  "createdAt": "2025-09-16T13:31:51.383Z",
  "updatedAt": "2025-09-21T14:10:12.000Z",
  "id": "JasTV4gv4NDVVogA",
  "name": "AI Email Triage Assistant",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "height": 464,
        "width": 320,
        "content": "# ü§ñ AI Email Triage Assistant\n\n## üìã M·ª•c ƒë√≠ch (Purpose)\nT·ª± ƒë·ªông ph√¢n lo·∫°i v√† x·ª≠ l√Ω email t·ª´ james@soxes.ch, s·ª≠ d·ª•ng AI ƒë·ªÉ ph√¢n t√≠ch n·ªôi dung v√† th·ª±c hi·ªán c√°c h√†nh ƒë·ªông ph√π h·ª£p theo t·ª´ng lo·∫°i email.\n\n## üöÄ Trigger\n- **Gmail Trigger**: Ki·ªÉm tra email ch∆∞a ƒë·ªçc t·ª´ james@soxes.ch\n- **T·∫ßn su·∫•t**: M·ªói gi·ªù v√†o ph√∫t 15\n- **B·ªô l·ªçc**: Ch·ªâ email unread t·ª´ sender c·ª• th·ªÉ\n\n## üîÑ C√°c b∆∞·ªõc ch√≠nh\n1. **Thu th·∫≠p Email** ‚Üí Chuy·ªÉn ƒë·ªïi HTML sang Markdown\n2. **Ti·ªÅn x·ª≠ l√Ω** ‚Üí Tr√≠ch xu·∫•t email g·ªëc (n·∫øu forwarded)\n3. **AI Ph√¢n t√≠ch** ‚Üí G·ªçi sub-workflow AI Analysis Service\n4. **Ph√¢n nh√°nh** ‚Üí Switch theo category (TASK_REQUEST, ESTIMATION_REQUEST, etc.)\n5. **X·ª≠ l√Ω h√†nh ƒë·ªông** ‚Üí T·∫°o Jira task, Confluence page, MS Teams notification\n6. **Ho√†n t·∫•t** ‚Üí ƒê√°nh d·∫•u email ƒë√£ ƒë·ªçc\n\n## üîê Credentials c·∫ßn thi·∫øt\n- **Gmail OAuth2**: ƒê·ªçc v√† qu·∫£n l√Ω email\n- **OpenAI API**: AI analysis (GPT-4)\n- **Jira/Confluence**: T·∫°o task v√† page\n- **MS Teams Webhook**: G·ª≠i th√¥ng b√°o"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -5200,
        -800
      ],
      "id": "sticky-main-overview",
      "name": "üìñ Workflow Overview"
    },
    {
      "parameters": {
        "height": 200,
        "width": 280,
        "content": "## üì® Email Collection & Processing\n\n**Ch·ª©c nƒÉng**: Thu th·∫≠p email unread v√† chu·∫©n b·ªã d·ªØ li·ªáu\n\n**Workflow**:\n1. Gmail Trigger ‚Üí L·∫•y email m·ªõi\n2. HTML to Markdown ‚Üí Chu·∫©n h√≥a format\n3. Extract Original Email ‚Üí X·ª≠ l√Ω forwarded email\n\n**Output**: Email content ƒë√£ ƒë∆∞·ª£c clean v√† structured"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4880,
        -600
      ],
      "id": "sticky-email-collection",
      "name": "üì® Email Collection"
    },
    {
      "parameters": {
        "height": 180,
        "width": 260,
        "content": "## üß† AI Analysis Hub\n\n**Sub-workflow**: DrLDQaf54G0ZhJpf\n\n**Ch·ª©c nƒÉng**:\n- Ph√¢n t√≠ch n·ªôi dung email b·∫±ng GPT-4o\n- Ph√¢n lo·∫°i category (TASK_REQUEST, ESTIMATION_REQUEST, etc.)\n- X√°c ƒë·ªãnh priority (High/Medium/Low)\n- Tr√≠ch xu·∫•t metadata\n\n**Retry Logic**: 2 l·∫ßn, m·ªói l·∫ßn c√°ch 5 gi√¢y"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4200,
        -600
      ],
      "id": "sticky-ai-analysis",
      "name": "üß† AI Analysis"
    },
    {
      "parameters": {
        "height": 240,
        "width": 300,
        "content": "## üîÄ Email Category Router\n\n**Switch Node**: Ph√¢n nh√°nh theo AI category\n\n**6 nh√°nh x·ª≠ l√Ω**:\n- **TASK_REQUEST** ‚Üí T·∫°o Jira task\n- **ESTIMATION_REQUEST** ‚Üí T·∫°o Confluence page\n- **CONFLUENCE_LINK_ESTIMATE** ‚Üí Ph√¢n t√≠ch link Confluence\n- **POLICY_UPDATE** ‚Üí G·ª≠i c·∫£nh b√°o MS Teams\n- **SPAM_MARKETING** ‚Üí Chuy·ªÉn v√†o spam\n- **OTHER** ‚Üí X·ª≠ l√Ω chung\n\n**Logic**: Exact string match v·ªõi AI output"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3760,
        -700
      ],
      "id": "sticky-category-router",
      "name": "üîÄ Category Router"
    },
    {
      "parameters": {
        "height": 160,
        "width": 240,
        "content": "## üìã Jira Task Creation\n\n**Nh√°nh**: TASK_REQUEST\n\n**Flow**:\n1. Prepare Data for Jira\n2. Call sub-Create-Jira-Task\n3. Mark email as read\n\n**Output**: Jira task v·ªõi AI summary v√† context"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2500,
        -900
      ],
      "id": "sticky-jira-task",
      "name": "üìã Jira Integration"
    },
    {
      "parameters": {
        "height": 160,
        "width": 240,
        "content": "## üìÑ Confluence Page Creation\n\n**Nh√°nh**: ESTIMATION_REQUEST\n\n**Flow**:\n1. Prepare Data for Confluence\n2. Call sub-Create-Confluence-Page\n3. Mark email as read\n\n**Output**: Structured estimation page v·ªõi AI breakdown"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2500,
        -1100
      ],
      "id": "sticky-confluence-page",
      "name": "üìÑ Confluence Integration"
    },
    {
      "parameters": {
        "height": 180,
        "width": 260,
        "content": "## üîó Confluence Link Analysis\n\n**Nh√°nh**: CONFLUENCE_LINK_ESTIMATE\n\n**Flow**:\n1. Extract Page ID from URL\n2. Fetch Confluence Page content\n3. Convert to Markdown\n4. AI Analysis for breakdown\n5. Create personal analysis page\n\n**Use case**: Estimate c√¥ng vi·ªác t·ª´ Confluence specs"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3200,
        300
      ],
      "id": "sticky-confluence-analysis",
      "name": "üîó Confluence Analysis"
    },
    {
      "parameters": {
        "height": 140,
        "width": 220,
        "content": "## üö® Policy Alert\n\n**Nh√°nh**: POLICY_UPDATE\n\n**Flow**:\n1. Prepare alert data\n2. Call MS Teams notification\n3. Mark as read\n\n**Use case**: C·∫£nh b√°o c·∫≠p nh·∫≠t policy quan tr·ªçng"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3600,
        -1350
      ],
      "id": "sticky-policy-alert",
      "name": "üö® Policy Alert"
    },
    {
      "parameters": {
        "height": 120,
        "width": 200,
        "content": "## üóëÔ∏è Spam Management\n\n**Nh√°nh**: SPAM_MARKETING\n\n**Action**: T·ª± ƒë·ªông chuy·ªÉn email v√†o th∆∞ m·ª•c Spam\n\n**Error Handling**: Continue n·∫øu fail"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2200,
        -400
      ],
      "id": "sticky-spam-management",
      "name": "üóëÔ∏è Spam Filter"
    },
    {
      "parameters": {
        "height": 140,
        "width": 240,
        "content": "## ‚ö° Error Handling\n\n**Global Error Workflow**: DbzKrYofpCNCrr50\n\n**Features**:\n- Continue on Gmail errors\n- AI retry logic (2x, 5s interval)\n- Error notification via MS Teams\n\n**Philosophy**: Fail gracefully, don't break the flow"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1600,
        -600
      ],
      "id": "sticky-error-handling",
      "name": "‚ö° Error Handling"
    },
    {
      "parameters": {
        "height": 200,
        "width": 280,
        "content": "## üß™ Testing & Monitoring\n\n**Manual Test Cases**:\n1. Forward email TASK_REQUEST ‚Üí Check Jira creation\n2. Send ESTIMATION_REQUEST ‚Üí Verify Confluence page\n3. Send Confluence link ‚Üí Test analysis flow\n4. Disconnect network during AI call ‚Üí Verify retry\n5. Invalid email format ‚Üí Check error handling\n\n**Monitoring**:\n- Check execution logs in n8n\n- Monitor AI API costs\n- Track error rates\n\n**Success Metrics**: >99% uptime, <1% error rate"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1300,
        -800
      ],
      "id": "sticky-testing-monitoring",
      "name": "üß™ Testing & Monitoring"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $input.first().json.category }}",
                    "rightValue": "TASK_REQUEST",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7ba53fd4-cba4-4cfc-a833-659d7725ee40"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "TASK_REQUEST"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "bd24ffd1-af3f-4708-a8aa-9a2ee321e11f",
                    "leftValue": "={{ $input.first().json.category }}",
                    "rightValue": "=ESTIMATION_REQUEST",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ESTIMATION_REQUEST"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7a1f79cb-387a-42cd-9496-9da2fc940ee6",
                    "leftValue": "={{ $input.first().json.category }}",
                    "rightValue": "POLICY_UPDATE",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "POLICY_UPDATE"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d5d4a407-6d9c-4b44-8125-e64846e8b114",
                    "leftValue": "={{ $input.first().json.category }}",
                    "rightValue": "SPAM_MARKETING",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "SPAM_MARKETING"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ecccaa93-85df-4db5-bd2a-7b40da0b0ccb",
                    "leftValue": "={{ $input.first().json.category }}",
                    "rightValue": "CONFLUENCE_LINK_ESTIMATE",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CONFLUENCE_LINK_ESTIMATE"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "25a7cd29-1d35-43fd-b02a-b50f3bbefe80",
                    "leftValue": "={{ $input.first().json.category }}",
                    "rightValue": "OTHER",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ORTHER"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -3760,
        -432
      ],
      "id": "247f54ab-9fcc-4566-81f8-efd42c3bbc72",
      "name": "[DECIDE] - Action by Email Category"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Extracts a Confluence page ID from a URL\n * @param {string} inputNodeName - The name of the node containing the Confluence URL\n * @returns {Object} An object containing the extracted pageId or null if not found\n */\nfunction extractPageId(inputNodeName = '[PARSE] - AI JSON Response') {\n  try {\n    // Get URL from the input node\n    const url = $(inputNodeName).first().json.confluence_url;\n    \n    if (!url) {\n      console.warn(\"No Confluence URL found in the input.\");\n      return { pageId: null, error: \"No URL provided\" };\n    }\n\n    // Try to extract pageId from URL parameters\n    const urlParams = new URL(url).searchParams;\n    if (urlParams.has('pageId')) {\n      return validatePageId(urlParams.get('pageId'));\n    }\n\n    // Try to extract from friendly URL pattern\n    const friendlyUrlMatch = url.match(/\\/pages\\/(\\d+)/);\n    if (friendlyUrlMatch && friendlyUrlMatch[1]) {\n      return validatePageId(friendlyUrlMatch[1]);\n    }\n\n    console.warn(\"No valid Confluence page ID pattern found in URL:\", url);\n    return { pageId: null, error: \"No valid page ID pattern found\" };\n\n  } catch (error) {\n    console.error(\"Error extracting page ID:\", error.message);\n    return { \n      pageId: null, \n      error: error.message,\n      stack: error.stack \n    };\n  }\n}\n\n/**\n * Validates if the extracted ID is a valid Confluence page ID\n * @param {string} pageId - The page ID to validate\n * @returns {Object} An object with the validated pageId or null if invalid\n */\nfunction validatePageId(pageId) {\n  if (!pageId) {\n    return { pageId: null, error: \"No page ID provided\" };\n  }\n\n  // Check if pageId contains only digits\n  if (/^\\d+$/.test(pageId)) {\n    return { pageId, error: null };\n  }\n\n  console.error(\"Invalid page ID format. Expected numeric value, got:\", pageId);\n  return { pageId: null, error: \"Invalid page ID format\" };\n}\n\n// Main execution\nconst result = extractPageId();\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3536,
        -80
      ],
      "id": "a6748129-ccbf-4a1a-9d2c-51a2701a9740",
      "name": "[EXTRACT] - Confluence Page ID from URL"
    },
    {
      "parameters": {
        "url": "=https://soxes.atlassian.net/wiki/rest/api/content/{{ $('[EXTRACT] - Confluence Page ID from URL').first().json.pageId}}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "jiraSoftwareCloudApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "expand",
              "value": "body.storage"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3312,
        -80
      ],
      "id": "3ae0a767-8caa-4cf0-a8da-ad4491519e03",
      "name": "[GET] - Confluence Page",
      "credentials": {
        "jiraSoftwareCloudApi": {
          "id": "vuqHzqXD5jQQXkbq",
          "name": "Atlassian_Credential_soxes"
        }
      }
    },
    {
      "parameters": {
        "html": "={{ $json.body.storage.value }}",
        "options": {}
      },
      "type": "n8n-nodes-base.markdown",
      "typeVersion": 1,
      "position": [
        -3088,
        -80
      ],
      "id": "6cf569ce-cd88-45ee-99f3-ba51e9478bb6",
      "name": "Markdown"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4",
          "mode": "list",
          "cachedResultName": "GPT-4"
        },
        "messages": {
          "values": [
            {
              "content": "=You are a senior technical analyst. Your task is to read the following project requirements and provide a detailed technical task breakdown suitable for a developer to start working on.\n\nReturn ONLY a valid JSON object with a single key \"task_breakdown\". The value should be a single string containing a list of tasks formatted with Markdown bullet points (`- Task A`).\n\n**Project Requirements to Analyze:**\n---\n{{ $json.markdown }}\n---\n\n**Output Format (JSON only):**\n{\n  \"task_breakdown\": \"string\"\n}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -2864,
        -80
      ],
      "id": "c996b767-624b-44a1-abd0-f2ca9c0194a5",
      "name": "[ANALYZE] - Confluence Content for Breakdown",
      "credentials": {
        "openAiApi": {
          "id": "rvEVzeazfzW6v66O",
          "name": "OPEN_AI__Credential_tiennguyen15"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * Extracts and parses JSON from AI model response\n * Supports both OpenAI and GoogleAI response formats\n * @returns {Object} Parsed JSON object or error object\n */\nfunction parseAIResponse() {\n  const aiOutput = $input.first().json;\n  \n  // Extract content based on provider format\n  const getContent = () => {\n    // OpenAI format\n    if (aiOutput.choices?.[0]?.message?.content) {\n      return aiOutput.choices[0].message.content;\n    }\n    // GoogleAI format\n    if (aiOutput.message?.content) {\n      return aiOutput.message.content;\n    }\n    // Fallback to stringify if no known format matches\n    return JSON.stringify(aiOutput);\n  };\n\n  try {\n    const jsonString = getContent();\n    \n    // Extract JSON from markdown code block if present\n    const jsonMatch = jsonString.match(/```(?:json)?\\s*([\\s\\S]*?)\\s*```/);\n    const jsonToParse = jsonMatch ? jsonMatch[1] : jsonString;\n    \n    // Parse and validate the JSON\n    const parsed = JSON.parse(jsonToParse);\n    \n    // Ensure we return an object\n    if (parsed && typeof parsed === 'object') {\n      return parsed;\n    }\n    \n    throw new Error('Parsed content is not a valid JSON object');\n    \n  } catch (error) {\n    console.error('Error parsing AI response:', {\n      error: error.message,\n      input: aiOutput,\n      stack: error.stack\n    });\n    \n    return {\n      success: false,\n      error: 'Failed to parse AI response',\n      details: error.message,\n      originalContent: jsonString\n    };\n  }\n}\n\n// Execute and return the result\nreturn parseAIResponse();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2512,
        -80
      ],
      "id": "bfb4a42f-c09c-4357-b050-a86088fa0201",
      "name": "[PARSE] - Breakdown JSON"
    },
    {
      "parameters": {
        "jsCode": "// Helper function ƒë·ªÉ \"v√¥ hi·ªáu h√≥a\" c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát trong XML/HTML\nfunction escapeXml(unsafe) {\n  if (typeof unsafe !== 'string' || !unsafe) { return unsafe; }\n  return unsafe.replace(/[<>&'\"]/g, function (c) {\n    switch (c) {\n      case '<': return '&lt;';\n      case '>': return '&gt;';\n      case '&': return '&amp;';\n      case '\\'': return '&apos;';\n      case '\"': return '&quot;';\n    }\n  });\n}\n// -- B·∫†N C·∫¶N THAY ƒê·ªîI C√ÅC GI√Å TR·ªä TRONG PH·∫¶N N√ÄY --\nconst spaceKey = \"~james\"; // V√≠ d·ª•: \"DEV\", \"PROJ\"\nconst parentPageId = \"673022176\"; // V√≠ d·ª•: \"12345678\"\n// T√πy ch·ªçn: ID trang cha trong space c√° nh√¢n c·ªßa b·∫°n\n// --------------------------------------------------\n\n// L·∫•y d·ªØ li·ªáu t·ª´ c√°c node tr∆∞·ªõc ƒë√≥ trong lu·ªìng n√†y\nconst originalPageNode = $('[GET] - Confluence Page').first().json;\nconst originalUrl = $('[PARSE] - AI JSON Response').first().json.confluence_url; // L·∫•y t·ª´ node parse c·ªßa email\nconst cleanTextNode = $('Markdown').first().json;\nconst breakdownNode = $('[PARSE] - Breakdown JSON').first().json;\n\n// L·∫•y v√† l√†m s·∫°ch (escape) c√°c d·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ch√®n v√†o n·ªôi dung\nconst originalPageTitle = escapeXml(originalPageNode.title);\nconst aiTaskBreakdown = escapeXml(breakdownNode.task_breakdown).replace(/\\n/g, '<br />');\nconst originalPageCleanText = escapeXml(cleanTextNode.cleanText);\n\n// T·∫°o n·ªôi dung cho trang ph√¢n t√≠ch c√° nh√¢n\nconst pageContent = `\n    <h2>Trang G·ªëc Tham chi·∫øu</h2>\n    <ul><li><strong>Link:</strong> <a href=\"${originalUrl}\">${originalPageTitle}</a></li></ul>\n    <hr />\n    <h2>Ph√¢n t√≠ch &amp; B√≥c t√°ch C√¥ng vi·ªác c·ªßa AI</h2>\n    <ac:structured-macro ac:name=\"panel\">\n        <ac:parameter ac:name=\"title\">AI Suggested Task Breakdown</ac:parameter>\n        <ac:rich-text-body><p>${aiTaskBreakdown}</p></ac:rich-text-body>\n    </ac:structured-macro>\n    <hr />\n    <h2>Ghi ch√∫ c√° nh√¢n</h2>\n    <p><em>(Th√™m ghi ch√∫, ph√¢n t√≠ch, ho·∫∑c c√°c c√¢u h·ªèi c·∫ßn l√†m r√µ c·ªßa b·∫°n ·ªü ƒë√¢y...)</em></p>\n    <hr />\n    <h2>N·ªôi dung G·ªëc t·ª´ trang Project</h2>\n    <blockquote><p>${originalPageCleanText.replace(/\\n/g, '<br />')}</p></blockquote>\n`;\n\n// C·∫•u tr√∫c JSON body cu·ªëi c√πng ƒë·ªÉ g·ª≠i cho Confluence API\nreturn {\n  \"type\": \"page\",\n  \"title\": `[Ph√¢n t√≠ch] - ${originalPageNode.title}`, // Title kh√¥ng c·∫ßn escape\n  \"space\": { \"key\":spaceKey },\n  \"ancestors\": [{ \"id\": parentPageId }],\n  \"body\": {\n    \"storage\": {\n      \"value\": pageContent,\n      \"representation\": \"storage\"\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2288,
        -80
      ],
      "id": "e4f1ac5c-d6d7-461b-84e3-9c0424196535",
      "name": "[PARSE] - JSON for Create Confluence Page From Link-"
    },
    {
      "parameters": {
        "operation": "markAsRead",
        "messageId": "={{ $('[GET] - Unread Email').item.json.id }}"
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -1840,
        -368
      ],
      "id": "f0402d30-30eb-43c0-aa16-024348b8ff36",
      "name": "[SET] - Mark as Read",
      "webhookId": "43ec369d-e635-4227-a9be-2085db705515",
      "credentials": {
        "gmailOAuth2": {
          "id": "YIw7bvsLVAOVl1mk",
          "name": "Gmail account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://soxes.atlassian.net/wiki/rest/api/content",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "jiraSoftwareCloudApi",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2064,
        -80
      ],
      "id": "d3a55d13-6f4d-4ed0-8985-bfec184be8ba",
      "name": "[CREATE] - Confluence Page -CONFLUENCE_LINK_ESTIMATE",
      "credentials": {
        "jiraSoftwareCloudApi": {
          "id": "vuqHzqXD5jQQXkbq",
          "name": "Atlassian_Credential_soxes"
        }
      }
    },
    {
      "parameters": {
        "operation": "addLabels",
        "messageId": "={{ $('[GET] - Unread Email').item.json.id }}",
        "labelIds": [
          "SPAM"
        ]
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -2064,
        -272
      ],
      "id": "2c11b834-804f-41c0-9a35-d9b26588bc08",
      "name": "[MOVE] - Email to Spam",
      "webhookId": "e976c9c8-3825-4ec9-8eda-083b13257a4e",
      "credentials": {
        "gmailOAuth2": {
          "id": "YIw7bvsLVAOVl1mk",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "removeLabels",
        "messageId": "={{ $('[GET] - Unread Email').item.json.id }}",
        "labelIds": [
          "INBOX",
          "Label_1140568986325750094"
        ]
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -2064,
        112
      ],
      "id": "ed190b7e-18f5-4760-837c-61d42ea61d51",
      "name": "Remove label from message",
      "webhookId": "1d70d30a-ace4-42ff-a81a-fb711fb054c8",
      "credentials": {
        "gmailOAuth2": {
          "id": "YIw7bvsLVAOVl1mk",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyHour",
              "minute": 15
            }
          ]
        },
        "simple": false,
        "filters": {
          "readStatus": "unread",
          "sender": "james@soxes.ch"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1.3,
      "position": [
        -4880,
        -368
      ],
      "id": "b584e897-f92c-4045-9239-ffb9c1e96b68",
      "name": "[GET] - Unread Email",
      "credentials": {
        "gmailOAuth2": {
          "id": "YIw7bvsLVAOVl1mk",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const nodeConvert =  $(\"[CONVERT]  Email Content to Markdown\").first().json;\nconst fullBody = nodeConvert.markdown;\n\nconst output = {\n  original_sender: nodeConvert.from,\n  clean_body: fullBody,\n  is_forwarded: false\n};\n\nconst outlookMarker = '\\nFrom: ';\nlet markerIndex = fullBody.lastIndexOf(outlookMarker); \n\nif (markerIndex !== -1) {\n  const sentIndex = fullBody.indexOf('\\nSent: ', markerIndex);\n  if (sentIndex === -1 || sentIndex > markerIndex + 300) { // N·∫øu kh√¥ng c√≥ d√≤ng Sent ho·∫∑c n√≥ ·ªü qu√° xa\n    markerIndex = -1; // Xem nh∆∞ kh√¥ng t√¨m th·∫•y\n  }\n}\n\nif (markerIndex === -1) {\n    const gmailMarker = '---------- Forwarded message ---------';\n    markerIndex = fullBody.indexOf(gmailMarker);\n}\n\nif (markerIndex !== -1) {\n  output.is_forwarded = true;\n  \n  // L·∫•y to√†n b·ªô n·ªôi dung c·ªßa email g·ªëc (t·ª´ d·∫•u hi·ªáu tr·ªü ƒëi)\n  const forwardedBlock = fullBody.substring(markerIndex).trim();\n  \n  // Tr√≠ch xu·∫•t ng∆∞·ªùi g·ª≠i g·ªëc (original_sender)\n  const fromMatch = forwardedBlock.match(/From: (.*)/);\n  if (fromMatch && fromMatch[1]) {\n    output.original_sender = fromMatch[1].split('\\n')[0].trim() ?? ''; // L·∫•y d√≤ng From v√† l√†m s·∫°ch\n  }\n\n  // Tr√≠ch xu·∫•t n·ªôi dung s·∫°ch (clean_body)\n  // N·ªôi dung s·∫°ch l√† ph·∫ßn n·∫±m SAU d√≤ng Subject: v√† m·ªôt d√≤ng tr·ªëng\n  const subjectMatch = forwardedBlock.match(/\\nSubject: .*/); \n  if (subjectMatch) {\n      const headersEndIndex = subjectMatch.index + subjectMatch[0].length;\n      output.clean_body = forwardedBlock.substring(headersEndIndex).trim();\n  } else {\n      // N·∫øu kh√¥ng t√¨m th·∫•y Subject (tr∆∞·ªùng h·ª£p hi·∫øm), l·∫•y to√†n b·ªô block\n      output.clean_body = forwardedBlock;\n  }\n}\noutput.original_sender = output.original_sender ?? '';\n// Tr·∫£ v·ªÅ d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω\nreturn output;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4432,
        -368
      ],
      "id": "da4060b6-6fae-4cd0-8a81-101765cc6315",
      "name": "[PRE-PROCESS] - Extract Original Email"
    },
    {
      "parameters": {
        "html": "={{ $('[GET] - Unread Email').item.json.html }}",
        "destinationKey": "markdown",
        "options": {}
      },
      "type": "n8n-nodes-base.markdown",
      "typeVersion": 1,
      "position": [
        -4656,
        -368
      ],
      "id": "564ce55f-33d9-49f8-a81b-a0d64ef8cbff",
      "name": "[CONVERT]  Email Content to Markdown"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "50312bbf-0413-4726-aded-dcbf93ffb52b",
              "name": "summary",
              "value": "=[EMAIL TASK] - {{ $('[CALL] AI Analysis Service').item.json.summary }}",
              "type": "string"
            },
            {
              "id": "415a18ff-8d97-4653-b674-a1cbab4a8368",
              "name": "description",
              "value": "=h3. üìã B·ªëi c·∫£nh (Context)\n* *Ng∆∞·ªùi g·ª≠i:* {{ $('[DECIDE] - Action by Email Category').item.json.sender_name }}\n* *ƒê·ªô ∆∞u ti√™n AI ƒë·ªÅ xu·∫•t:* {{ $('[CALL] AI Analysis Service').item.json.priority }}\n\n----\n\nh3. ‚ú® T√≥m t·∫Øt c·ªßa AI\n{{ $('[CALL] AI Analysis Service').item.json.summary }}\n\n----\n\nh3. üìß N·ªôi dung Email g·ªëc\n{quote}\n{{ $('[PRE-PROCESS] - Extract Original Email').item.json.clean_body }}\n{quote}\n\n----\n\nh3. üìù Ghi ch√∫\n_Ticket n√†y ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông t·ª´ h·ªá th·ªëng AI Email Triage Assistant_",
              "type": "string"
            },
            {
              "id": "73910815-273b-480d-a51c-c915bad39414",
              "name": "mappedPriority",
              "value": "={{ $('[CALL] AI Analysis Service').item.json.mappedPriority }}",
              "type": "string"
            },
            {
              "id": "8b3890d0-d11a-4884-a63d-c880a44eb01b",
              "name": "mappedPriority",
              "value": "={{ $json.mappedPriority }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2288,
        -656
      ],
      "id": "60eac4e9-7ed7-4f49-b768-cad78114515d",
      "name": "[PREPARE] - Data for Jira"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "DrLDQaf54G0ZhJpf",
          "mode": "list",
          "cachedResultUrl": "/workflow/DrLDQaf54G0ZhJpf",
          "cachedResultName": "sub-AI-Analysis-Service"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {}
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -3984,
        -368
      ],
      "id": "2ab439f3-e075-48a4-a928-74671fa8538b",
      "name": "[CALL] AI Analysis Service"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "DwfZVlGV8BkAy0mU",
          "mode": "list",
          "cachedResultUrl": "/workflow/DwfZVlGV8BkAy0mU",
          "cachedResultName": "sub-Create-Jira-Task"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {}
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -2064,
        -656
      ],
      "id": "7393fe8f-69cb-4f88-82d6-6ab45ae7de63",
      "name": "[Call] - Create Jira Task"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "793905ac-0c5b-4d6d-ae36-8a3ef9e420f9",
              "name": "content",
              "value": "",
              "type": "string"
            },
            {
              "id": "3d37d8c8-46a1-4d69-99ab-3f402fca15d7",
              "name": "spaceKey",
              "value": "~james",
              "type": "string"
            },
            {
              "id": "13d1e4d9-9898-439c-8f86-fb959ecc3733",
              "name": "parentId",
              "value": 673022176,
              "type": "number"
            },
            {
              "id": "a2eba5b5-ad41-4432-a7fd-92dc50f8bad5",
              "name": "originalSender",
              "value": "={{ $('[PRE-PROCESS] - Extract Original Email').item.json.original_sender }}",
              "type": "string"
            },
            {
              "id": "24f69a55-c424-412a-8b0d-586ce08325a7",
              "name": "cleanBody",
              "value": "={{ $('[PRE-PROCESS] - Extract Original Email').item.json.clean_body }}",
              "type": "string"
            },
            {
              "id": "7fc401dd-c745-4686-ace6-b3ebb7195d59",
              "name": "summary",
              "value": "={{ $('[CALL] AI Analysis Service').item.json.summary }}",
              "type": "string"
            },
            {
              "id": "26f0aa19-3fe1-49f9-a56e-b63d49f479c1",
              "name": "priority",
              "value": "={{ $('[CALL] AI Analysis Service').item.json.priority }}",
              "type": "string"
            },
            {
              "id": "b55a8c26-afd8-4335-b477-64bfbce38d0b",
              "name": "mappedPriority",
              "value": "={{ $('[CALL] AI Analysis Service').item.json.mappedPriority }}",
              "type": "string"
            },
            {
              "id": "d322421f-3a01-4e17-b730-3136fee66249",
              "name": "taskBreakdown",
              "value": "={{ $('[CALL] AI Analysis Service').item.json.task_breakdown }}",
              "type": "string"
            },
            {
              "id": "2a3ce81f-d756-4605-af94-d13d255f621d",
              "name": "aiOuput",
              "value": "={{ $('[CALL] AI Analysis Service').item.json }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2288,
        -848
      ],
      "id": "38f125bf-ff0f-418e-9cc9-c3e2019f38f7",
      "name": "[PREPARE] - Data for Create Confluence"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "05a7cdc2-fa1e-4278-801f-e5bf4ed3734e",
              "name": "subject",
              "value": "={{ $('[GET] - Unread Email').item.json.headers.subject }}",
              "type": "string"
            },
            {
              "id": "a6e6bc61-12d2-4e0c-a5cb-a1b0af2fbee0",
              "name": "sender",
              "value": "={{ $('[PRE-PROCESS] - Extract Original Email').item.json?.original_sender }}",
              "type": "string"
            },
            {
              "id": "8a5d1e6f-9682-41b3-8c96-b4b0c2e59390",
              "name": "body",
              "value": "={{ $('[PRE-PROCESS] - Extract Original Email').item.json.clean_body }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4208,
        -368
      ],
      "id": "698b3496-291c-41cf-8416-5a758d02fc4e",
      "name": "[PREPARE] - Data for AI Analysis"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "RijpYfQk5ngFJNpN",
          "mode": "list",
          "cachedResultUrl": "/workflow/RijpYfQk5ngFJNpN",
          "cachedResultName": "sub-Create-Confluence-Page"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {}
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -2064,
        -848
      ],
      "id": "5ae81b95-58a7-4690-a806-d9f0ca6c1665",
      "name": "Call 'sub-Create-Confluence-Page'"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "79c933f0-150e-4d83-8b94-267023810601",
              "name": "senderName",
              "value": "={{ $('[CALL] AI Analysis Service').item.json.sender_name }}",
              "type": "string"
            },
            {
              "id": "85852d7a-45ae-423c-b920-dac62f9118c5",
              "name": "emailSubject",
              "value": "={{ $('[GET] - Unread Email').item.json.headers.subject }}",
              "type": "string"
            },
            {
              "id": "e41f77b2-105b-4d66-a461-f172e65a40e8",
              "name": "aiSummary",
              "value": "={{ $('[CALL] AI Analysis Service').item.json.summary }}",
              "type": "string"
            },
            {
              "id": "a4289af6-0acd-4bb3-8e45-07ad37e04698",
              "name": "originalSender",
              "value": "=",
              "type": "string"
            },
            {
              "id": "19f97b90-3e55-4e65-afe0-6a804aeec609",
              "name": "text",
              "value": "**ƒê·ªÅ ngh·ªã team ki·ªÉm tra v√† c√≥ h√†nh ƒë·ªông k·ªãp th·ªùi ƒë·ªÉ ƒë·∫£m b·∫£o c√°c d·ª± √°n kh√¥ng b·ªã ·∫£nh h∆∞·ªüng.**",
              "type": "string"
            },
            {
              "id": "44a322b7-cb66-4a06-981d-f106a853297c",
              "name": "activityTitle",
              "value": "üö® C·∫¢NH B√ÅO: C√ì C·∫¨P NH·∫¨T CH√çNH S√ÅCH QUAN TR·ªåNG",
              "type": "string"
            },
            {
              "id": "c99aa622-27fe-4a0d-b04a-13de43bc6202",
              "name": "activitySubtitle",
              "value": "=From email : **{{ $('[CALL] AI Analysis Service').item.json.sender_name }}**",
              "type": "string"
            },
            {
              "id": "fcd8d032-95f6-42a3-9f66-d822132b9fbd",
              "name": "summary",
              "value": "=Policy Update Alert: {{ $('[GET] - Unread Email').item.json.headers.subject }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3392,
        -1072
      ],
      "id": "81e8d276-4074-4bee-8c6a-861a97986c7a",
      "name": "[PREPARE] - Data for MSTeam"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "9K2hf3sZ3NJ8p8GE",
          "mode": "list",
          "cachedResultUrl": "/workflow/9K2hf3sZ3NJ8p8GE",
          "cachedResultName": "sub-Send-MS-Teams-Message"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {}
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -2896,
        -1072
      ],
      "id": "9e19b51b-d98e-4bc0-9a8d-575f047c5052",
      "name": "Call 'sub-Send-MS-Teams-Message'"
    }
  ],
  "connections": {
    "[DECIDE] - Action by Email Category": {
      "main": [
        [
          {
            "node": "[PREPARE] - Data for Jira",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "[PREPARE] - Data for Create Confluence",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "[PREPARE] - Data for MSTeam",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "[MOVE] - Email to Spam",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "[EXTRACT] - Confluence Page ID from URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Remove label from message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[EXTRACT] - Confluence Page ID from URL": {
      "main": [
        [
          {
            "node": "[GET] - Confluence Page",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[GET] - Confluence Page": {
      "main": [
        [
          {
            "node": "Markdown",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Markdown": {
      "main": [
        [
          {
            "node": "[ANALYZE] - Confluence Content for Breakdown",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[ANALYZE] - Confluence Content for Breakdown": {
      "main": [
        [
          {
            "node": "[PARSE] - Breakdown JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[PARSE] - Breakdown JSON": {
      "main": [
        [
          {
            "node": "[PARSE] - JSON for Create Confluence Page From Link-",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[PARSE] - JSON for Create Confluence Page From Link-": {
      "main": [
        [
          {
            "node": "[CREATE] - Confluence Page -CONFLUENCE_LINK_ESTIMATE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Remove label from message": {
      "main": [
        [
          {
            "node": "[SET] - Mark as Read",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[CREATE] - Confluence Page -CONFLUENCE_LINK_ESTIMATE": {
      "main": [
        [
          {
            "node": "[SET] - Mark as Read",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[MOVE] - Email to Spam": {
      "main": [
        [
          {
            "node": "[SET] - Mark as Read",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[GET] - Unread Email": {
      "main": [
        [
          {
            "node": "[CONVERT]  Email Content to Markdown",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[PRE-PROCESS] - Extract Original Email": {
      "main": [
        [
          {
            "node": "[PREPARE] - Data for AI Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[CONVERT]  Email Content to Markdown": {
      "main": [
        [
          {
            "node": "[PRE-PROCESS] - Extract Original Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[PREPARE] - Data for Jira": {
      "main": [
        [
          {
            "node": "[Call] - Create Jira Task",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[CALL] AI Analysis Service": {
      "main": [
        [
          {
            "node": "[DECIDE] - Action by Email Category",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[Call] - Create Jira Task": {
      "main": [
        [
          {
            "node": "[SET] - Mark as Read",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[PREPARE] - Data for Create Confluence": {
      "main": [
        [
          {
            "node": "Call 'sub-Create-Confluence-Page'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[PREPARE] - Data for AI Analysis": {
      "main": [
        [
          {
            "node": "[CALL] AI Analysis Service",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call 'sub-Create-Confluence-Page'": {
      "main": [
        [
          {
            "node": "[SET] - Mark as Read",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[PREPARE] - Data for MSTeam": {
      "main": [
        [
          {
            "node": "Call 'sub-Send-MS-Teams-Message'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call 'sub-Send-MS-Teams-Message'": {
      "main": [
        [
          {
            "node": "[SET] - Mark as Read",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "saveExecutionProgress": true,
    "callerPolicy": "workflowsFromSameOwner",
    "executionOrder": "v0",
    "errorWorkflow": "TblM55auqwhaZ2F7"
  },
  "staticData": {
    "node:[GET] - Unread Email": {
      "[GET] - Unread Email": {
        "lastTimeChecked": 1758350518,
        "possibleDuplicates": [
          "1995d34d7cd84ced"
        ]
      }
    }
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "cf1ba3ae-ee72-49c2-826e-9305f906dfd7",
  "triggerCount": 1,
  "shared": [
    {
      "createdAt": "2025-09-16T13:31:51.383Z",
      "updatedAt": "2025-09-16T13:31:51.383Z",
      "role": "workflow:owner",
      "workflowId": "JasTV4gv4NDVVogA",
      "projectId": "9I0qukrB9koLQXrY"
    }
  ],
  "tags": []
}